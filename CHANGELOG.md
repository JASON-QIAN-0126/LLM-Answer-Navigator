# 更新日志

## [1.2.0] - 开发中

### 🎉 重大更新：右侧时间线导航

#### ✨ 全新 UI 设计
- **右侧时间线导航器**：页面右侧显示纵向时间线，每个节点代表一个对话
  - 📍 **气泡式均匀分布**：节点根据数量在时间线上均匀分布，新节点加入时旧节点自动上浮
  - 🎯 点击节点跳转到对应 AI 回答并高亮
  - 💬 鼠标悬浮显示问题内容预览（tooltip，最多 80 字符）
  - 🟢 当前对话节点绿色高亮，放大显示，带阴影
  - 👀 智能跟随：手动滚动时自动更新 active 状态

#### 🔧 架构重构
- **Prompt-Answer 配对系统**
  - 定义 `PromptAnswerPair` 类型，包含用户问题和 AI 回答的完整信息
  - 扩展 `SiteAdapter` 接口，添加 `getPromptAnswerPairs()` 方法
  - ChatGPT 适配器实现智能配对，扫描 user-assistant 消息序列
- **索引管理器重构**
  - 基于 `PromptAnswerItem` 重构 `AnswerIndexManager`
  - 添加 `relativePosition` 字段用于位置映射
  - 新增 `getItems()`, `getItemByIndex()`, `getCurrentItem()` 等接口
  - 保留向后兼容的旧接口
- **移除旧 UI**
  - 移除右下角悬浮按钮导航（NavigatorUI）
  - 移除主题系统（时间线使用固定样式）
  - 文件大小从 42.5kb 降到 32.6kb

#### ⌨️ 快捷键更新
- `Alt/Option + ↑/↓`: 上/下一个对话（保持不变）
- `Alt/Option + D`: 显示/隐藏时间线（替代旧的 UI 切换）

### 🚀 新增功能
- **支持新对话动态上树**
  - 在当前对话中发送新提问时，时间线会自动检测并添加新节点
  - 配合“气泡布局”，新节点加入底部时，旧节点会自动向上浮动调整位置
  - 自动选中最新发送的消息，无需手动滚动
- **智能滚动跟随**
  - 用户手动滚动页面时，时间线会自动检测当前视口中的对话
  - 实时更新右侧节点的 Active 状态，实现双向同步
  - 优化判定算法：基于视口中线实时检测，精准定位当前阅读内容

### 💎 视觉体验
- **时间线布局优化**
  - 弃用基于页面像素高度的映射逻辑，解决节点不可见/重叠问题
  - 采用**首尾固定、中间均分**的策略
  - 彻底解决了因页面高度计算延迟导致的节点重叠或不可见问题
  - 视觉效果更整洁，符合“新消息在底部，旧消息上浮”的直觉

### 🐛 问题修复
- **修复滚动同步失效问题**
  - 使用**事件捕获 (Capture Phase)** 监听全局滚动事件
  - 解决了 ChatGPT 等单页应用因内部容器滚动导致 `window.scroll` 无效的问题
  - 确保无论是鼠标滚轮、触摸板还是拖动滚动条，都能精准触发节点状态更新
- **修复点击跳转与滚动的冲突**
  - 引入锁机制，防止点击节点自动滚动时误触发索引更新
  - 解决了“点击第 2 个却高亮最后一个”的 Bug
- **修复切换对话时的视觉残留**
  - 在检测到 URL 变化或重新初始化时，立即清理旧的时间线节点
  - 确保用户在等待新对话加载时看到的是干净的状态，而不是上一段对话的节点
- **修复时间线初始化时机问题**
  - 增加延迟初始化机制，适配页面加载较慢的情况
  - 如果首次扫描未找到节点，后续扫描成功后会自动唤醒时间线
  - 避免了“第一次进入不显示，刷新或第二次才显示”的 Bug
- **修复时间线节点不可见的问题**
  - 使用 `ResizeObserver` 监听容器高度变化，确保节点位置正确计算
  - 将 Z-Index 提升至浏览器最大值，防止被页面其他元素遮挡
  - 修复高度计算除以零的潜在问题
- **修复无节点生成问题**
  - 改进 ChatGPT 适配器逻辑，不再依赖严格的 user-assistant 配对
  - 以用户提问（Prompt）为核心生成节点，确保只要有问题就能导航
- **修复跳转目标**
  - 点击时间线节点现在正确跳转到 Prompt 位置（而不是 AI 回答）
- **修复跳转时总条数自动变动的问题**
  - 添加列表锁定机制，一旦扫描到问题后立即锁定
  - 跳转过程中总数保持固定，不再变动
  - 只在初次扫描未找到问题时允许5秒内自动重试
  - 切换对话时自动解锁并重新初始化

### 📚 文档更新
- 更新 README 添加时间线导航说明
- 更新使用方法和功能特性描述
- 更新项目结构文档

---

## [1.0.0] - 2024-11-22

### 🎉 首次发布

#### ✨ 核心功能
- 🎯 智能识别 ChatGPT 页面的 AI 回答
- 🔄 快速导航：通过浮动面板或快捷键在回答间跳转
- 🎨 视觉高亮：跳转时自动高亮当前回答
- 📍 位置显示：实时显示当前回答位置（如 "3 / 5"）

#### ⌨️ 快捷键
- **Mac**：
  - Option (⌥) + ↑：上一条回答
  - Option (⌥) + ↓：下一条回答
  - Option (⌥) + D：显示/隐藏导航面板
- **Windows/Linux**：
  - Alt + ↑：上一条回答
  - Alt + ↓：下一条回答
  - Alt + D：显示/隐藏导航面板

#### 🎨 主题系统
- 🌓 **跟随系统**（默认）：自动适配浏览器浅色/深色模式
  - 浅色模式 → 亮色主题（白黑搭配）
  - 深色模式 → 暗色主题
- 🟢 **绿色主题**：清新活力的绿色风格
- 💜 **薰衣草紫**：优雅浪漫的紫色风格
- ⚫ **暗色主题**：护眼的深色风格
- ⚪ **亮色主题**：简洁清爽的蓝白风格

#### 🔧 智能功能
- 自动检测 URL 变化，切换对话时自动更新
- 根据滚动位置智能更新当前索引
- 页面底部时自动定位到最后一条回答
- 单条对话支持滚动到顶部
- 加载状态显示，防止未准备好时误操作

#### 🎛️ 配置选项
- 主题选择（5 种主题 + 自动模式）
- ChatGPT 导航功能开关
- 自定义快捷键支持

#### 🌐 站点支持
- ✅ ChatGPT (chatgpt.com, chat.openai.com)
- 📋 可扩展架构，便于添加更多站点

#### 🐛 问题修复
- 修复输入框和模型选择器被错误识别为对话的问题
- 修复下移按钮消失的 bug
- 修复切换对话时索引未正确更新的问题
- 优化 DOM 选择器，提高识别准确性

#### 📚 文档
- 完整的 README 使用说明
- 适配器开发指南（ADAPTER_GUIDE.md）
- 详细的代码注释

---

## 技术栈
- TypeScript 5.3
- Chrome Extension Manifest V3
- esbuild

